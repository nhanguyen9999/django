<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xác suất bán hàng</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }
        h2 {
            color: #333;
        }
        #charts {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
        }
        .chart-container {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <h2>Xác suất bán hàng của Mặt hàng theo Nhóm hàng</h2>
    <div id="charts"></div>
    <script>
        Promise.all([
            fetch("/api/billlines/").then(res => res.json()),
            fetch("/api/products/").then(res => res.json()),
            fetch("/api/category/").then(res => res.json())
        ]).then(([billlines, products, categories]) => {
            const productMap = new Map(products.map(p => [p.product_code, p]));
            const categoryMap = new Map(categories.map(c => [c.category_id, c]));
            
            billlines.forEach(d => {
                const product = productMap.get(d.product__product_code);
                if (product) {
                    d["Nhóm hàng"] = `[${categoryMap.get(product.category_id)?.category_code}] ${categoryMap.get(product.category_id)?.category_name}`;
                    d["Mặt hàng"] = `[${product.product_code}] ${product.product_name}`;
                }
            });

            const nhomHangList = [...new Set(billlines.map(d => d["Nhóm hàng"]))].slice(0, 5);

            const mainContainer = d3.select("#charts")
                .style("display", "grid")
                .style("grid-template-columns", "repeat(3, 1fr)")
                .style("gap", "10px")
                .style("max-width", "1000px")
                .style("margin", "auto");

            nhomHangList.forEach(nhom => {
                const filteredData = billlines.filter(d => d["Nhóm hàng"] === nhom);

                const countByItem = d3.rollups(
                    filteredData,
                    v => new Set(v.map(d => d["bill__bill_code"])).size,
                    d => d["Mặt hàng"]
                ).map(([item, count]) => ({ item, count }));

                const totalOrders = new Set(filteredData.map(d => d["bill__bill_code"])).size;

                const probabilities = countByItem.map(d => ({
                    item: d.item,
                    probability: d.count / totalOrders
                })).sort((a, b) => a.probability - b.probability);

                const container = mainContainer.append("div")
                    .attr("class", "chart-container")
                    .style("border", "1px solid #ddd")
                    .style("padding", "10px")
                    .style("border-radius", "8px")
                    .style("background", "#f9f9f9");

                drawBarChart(container, probabilities, nhom);
            });
        });

        function drawBarChart(container, data, title) {
            const width = 450, height = 250;
            const margin = { top: 30, right: 20, bottom: 50, left: 175 };

            const svg = container.append("svg")
                .attr("width", width)
                .attr("height", height);

            const x = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.probability)])
                .range([margin.left, width - margin.right]);

            const y = d3.scaleBand()
                .domain(data.map(d => d.item))
                .range([height - margin.bottom, margin.top])
                .padding(0.3);

            const colorScale = d3.scaleOrdinal(d3.schemeCategory10)
                .domain(data.map(d => d.item));

            svg.append("g")
                .attr("transform", `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(x).ticks(5).tickFormat(d => `${(d * 100).toFixed(0)}%`));

            svg.append("g")
                .attr("transform", `translate(${margin.left},0)`)
                .call(d3.axisLeft(y));

            svg.selectAll("rect")
                .data(data)
                .enter().append("rect")
                .attr("x", margin.left)
                .attr("y", d => y(d.item))
                .attr("width", d => x(d.probability) - margin.left)
                .attr("height", y.bandwidth())
                .attr("fill", d => colorScale(d.item));

            svg.append("text")
                .attr("x", width / 2)
                .attr("y", margin.top / 2)
                .attr("text-anchor", "middle")
                .style("font-size", "14px")
                .style("font-weight", "bold")
                .text(title);
        }
    </script>
</body>
</html>
